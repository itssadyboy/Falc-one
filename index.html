<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falc-one AI Tutor</title>
    <!-- 
    All HTML, CSS, and JavaScript are contained within this single file, 
    as required by the environment's single-file mandate for web applications. 
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .falcon-icon { font-size: 1.5rem; margin-right: 0.5rem; filter: drop-shadow(0 0 5px rgba(45, 212, 191, 0.7)); }
        .file-upload-wrapper { position: relative; border: 2px dashed #4a5568; border-radius: 0.75rem; padding: 2rem; transition: all 0.3s ease; }
        .file-upload-wrapper:hover { border-color: #2dd4bf; background-color: rgba(45, 212, 191, 0.05); }
        .file-upload-input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .file-upload-label { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #a0aec0; cursor: pointer; }
        .file-upload-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .mode-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; background-color: transparent; border: 2px solid #4a5568; color: #a0aec0; transition: all 0.3s ease; }
        .mode-btn.active { background-color: #2dd4bf; color: #ffffff; border-color: #2dd4bf; box-shadow: 0 0 15px rgba(45, 212, 191, 0.4); }
        #chat-window { scrollbar-width: thin; scrollbar-color: #4a5568 #1f2937; }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: #1f2937; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 3px solid #1f2937; }
        .chat-bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.75rem; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble.user { background-color: #2dd4bf; color: #111827; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .chat-bubble.ai { background-color: #374151; color: #e5e7eb; border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .chat-bubble.loading { display: flex; align-items: center; }
        .chat-bubble.loading .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans flex flex-col min-h-screen">

    <header class="bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight text-white flex items-center">
                <span class="falcon-icon">ü¶Ö</span>
                Falc-one <span class="text-cyan-400 ml-2">AI Tutor</span>
            </h1>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <section id="upload-section" class="bg-gray-800/50 rounded-2xl p-6 md:p-8 shadow-2xl border border-gray-700 max-w-2xl mx-auto text-center transition-all duration-500">
            <h2 class="text-2xl font-bold text-white mb-2">Prepare for Your Exam</h2>
            <p class="text-gray-400 mb-6">Upload your study material (PDF, JPG, PNG) to get started.</p>
            
            <form id="upload-form">
                <div class="file-upload-wrapper">
                    <input type="file" id="study-material-input" name="study_material" class="file-upload-input" accept=".pdf,.png,.jpg,.jpeg">
                    <label for="study-material-input" class="file-upload-label">
                        <span class="file-upload-icon">üì§</span>
                        <span id="file-name-display">Choose a file...</span>
                    </label>
                </div>
                <button type="submit" id="upload-button" class="mt-6 w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg disabled:bg-gray-600 disabled:cursor-not-allowed">
                    Analyze Material
                </button>
            </form>
            <div id="status-area" class="mt-4 text-gray-300 h-6"></div>
        </section>

        <section id="tutor-section" class="hidden mt-8 max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 bg-gray-800/50 p-6 rounded-2xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4 border-b border-gray-600 pb-2">Material Summary</h3>
                    <div id="summary-content" class="text-gray-300 space-y-2 text-sm"></div>
                </div>

                <div class="md:col-span-2 bg-gray-800/50 rounded-2xl border border-gray-700 flex flex-col" style="height: 70vh;">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex items-center justify-center space-x-4">
                            <button id="teach-mode-btn" class="mode-btn active">üìö Teach Mode</button>
                            <button id="test-mode-btn" class="mode-btn">‚ùì Test Mode</button>
                        </div>
                        <p id="mode-description" class="text-center text-sm text-gray-400 mt-2">Ask questions about your material.</p>
                    </div>

                    <div id="chat-window" class="flex-grow p-4 overflow-y-auto flex flex-col"></div>

                    <div class="p-4 border-t border-gray-700 bg-gray-800/60 rounded-b-2xl">
                        <form id="chat-form" class="flex items-center space-x-3">
                            <input type="text" id="user-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-white" placeholder="Explain the concept of...">
                            <button type="submit" id="send-button" class="bg-cyan-500 text-white rounded-full p-3 hover:bg-cyan-600 transition-colors disabled:bg-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // New API Key provided by the user is placed here:
            const API_KEY = "AIzaSyAJZ44Qmp6KlAHgSbrPjSFM2nwI_DJ0POE"; 
            // Correct model for multimodal generation
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            const uploadForm = document.getElementById('upload-form');
            const statusArea = document.getElementById('status-area');
            const tutorSection = document.getElementById('tutor-section');
            const uploadSection = document.getElementById('upload-section');
            const summaryContent = document.getElementById('summary-content');
            const chatForm = document.getElementById('chat-form');
            const userInput = document.getElementById('user-input');
            const chatWindow = document.getElementById('chat-window');
            const teachModeBtn = document.getElementById('teach-mode-btn');
            const testModeBtn = document.getElementById('test-mode-btn');
            const modeDescription = document.getElementById('mode-description');
            const fileInput = document.getElementById('study-material-input');
            const fileNameDisplay = document.getElementById('file-name-display');
            const uploadButton = document.getElementById('upload-button');

            let currentMode = 'teach';
            let materialContext = '';

            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                } else {
                    fileNameDisplay.textContent = 'Choose a file...';
                }
            });

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!file) {
                    updateStatus('Please select a file first.', true);
                    return;
                }
                
                updateStatus('Processing file...', false);
                uploadButton.disabled = true;

                try {
                    let parts = [];
                    let extractedTextContent = "";

                    if (file.type.startsWith('image/')) {
                        const base64Data = await fileToBase64(file);
                        parts.push({
                            inlineData: {
                                mimeType: file.type,
                                data: base64Data
                            }
                        });
                        extractedTextContent = "Image content provided.";
                    } else if (file.type === 'application/pdf') {
                        extractedTextContent = await extractTextFromPdf(file);
                        parts.push({ text: extractedTextContent });
                    } else {
                        throw new Error('Unsupported file type. Please use PDF, JPG, or PNG.');
                    }
                    
                    updateStatus('Analyzing material with AI...', false);
                    
                    const analysisPrompt = `Analyze the following study material. Your goal is to act as an AI tutor. First, summarize the key topics and concepts found in the material in 3-5 concise bullet points. This summary will be shown to the student to confirm you've understood the material.`;
                    parts.unshift({ text: analysisPrompt });

                    const response = await callGeminiAPI(parts);

                    materialContext = `---STUDY MATERIAL CONTEXT---\n${extractedTextContent}\n\n---END OF CONTEXT---`;
                    summaryContent.innerHTML = formatAIResponse(response);
                    
                    updateStatus('Analysis complete. You can now start learning!', false);
                    uploadSection.classList.add('hidden');
                    tutorSection.classList.remove('hidden');
                    addMessageToChat('AI', 'Hello! I have reviewed your material. You can ask me questions in "Teach Mode" or I can generate quiz questions in "Test Mode".');
                } catch (error) {
                    updateStatus(`Error: ${error.message}`, true);
                } finally {
                    uploadButton.disabled = false;
                }
            });

            teachModeBtn.addEventListener('click', () => switchMode('teach'));
            testModeBtn.addEventListener('click', () => switchMode('test'));

            function switchMode(newMode) {
                currentMode = newMode;
                if (newMode === 'teach') {
                    teachModeBtn.classList.add('active');
                    testModeBtn.classList.remove('active');
                    modeDescription.textContent = 'Ask me anything about your study material.';
                    userInput.placeholder = 'Explain the concept of...';
                } else {
                    testModeBtn.classList.add('active');
                    teachModeBtn.classList.remove('active');
                    modeDescription.textContent = 'Enter a topic, and I will create a quiz question.';
                    userInput.placeholder = 'Generate a question about...';
                }
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = userInput.value.trim();
                if (!query) return;

                addMessageToChat('You', query);
                userInput.value = '';
                showLoadingIndicator();

                try {
                    let prompt = "";
                    if (currentMode === 'teach') {
                        prompt = `You are an AI Tutor in 'Teaching Mode'. A student has asked a question about the study material provided. Explain the concept clearly, concisely, and in a supportive tone. If the question is unrelated to the context, politely state that.\n\n${materialContext}\n\nStudent's question: "${query}"\n\nYour explanation:`;
                    } else {
                        prompt = `You are an AI Tutor in 'Test Mode'. Generate a single, relevant, multiple-choice question based on the study material to test the student's knowledge. The question can be about the topic "${query}" or a general question if the query is vague. Provide 4 options (A, B, C, D) and clearly state the correct answer on a new line, like this: 'Correct Answer: C'.\n\n${materialContext}\n\nTopic for question: "${query}"`;
                    }
                    
                    const response = await callGeminiAPI([{ text: prompt }]);
                    removeLoadingIndicator();
                    addMessageToChat('AI', response);
                } catch (error) {
                    removeLoadingIndicator();
                    addMessageToChat('AI', `Sorry, an error occurred: ${error.message}`);
                }
            });
            
            async function callGeminiAPI(parts) {
                let currentDelay = 1000;
                const maxRetries = 3;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const payload = {
                            contents: [{ parts: parts }]
                        };
                        
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            // Check if content exists before trying to access properties
                            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                                return data.candidates[0].content.parts[0].text;
                            } else {
                                throw new Error("Received an empty response from the AI model.");
                            }
                        } else {
                            const errorData = await response.json();
                            // Handle rate limiting (429) or server errors (>= 500) with exponential backoff
                            if (response.status === 429 || response.status >= 500) {
                                if (i < maxRetries - 1) {
                                    await new Promise(resolve => setTimeout(resolve, currentDelay));
                                    currentDelay *= 2;
                                    continue; // Retry
                                }
                            }
                            // Throw the final error message
                            throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                        }
                    } catch (error) {
                        // Handle network failure with exponential backoff
                        if (i < maxRetries - 1 && error.message.includes('Failed to fetch')) {
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2;
                            continue; // Retry for network issues
                        }
                        throw error;
                    }
                }
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = error => reject(error);
                });
            }

            async function extractTextFromPdf(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                }
                if (fullText.trim().length === 0) {
                     throw new Error('Could not extract any meaningful text from the PDF. Ensure it is not a scanned-only document without a text layer.');
                }
                return fullText;
            }

            function updateStatus(message, isError) {
                statusArea.textContent = message;
                statusArea.style.color = isError ? '#f87171' : '#6ee7b7';
            }
            
            function addMessageToChat(sender, message) {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('chat-bubble', sender === 'AI' ? 'ai' : 'user');
                messageWrapper.innerHTML = formatAIResponse(message);
                chatWindow.appendChild(messageWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showLoadingIndicator() {
                const loadingBubble = document.createElement('div');
                loadingBubble.id = 'loading-indicator';
                loadingBubble.classList.add('chat-bubble', 'ai', 'loading');
                loadingBubble.innerHTML = '<div class="spinner"></div><span>Thinking...</span>';
                chatWindow.appendChild(loadingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function removeLoadingIndicator() {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) indicator.remove();
            }

            function formatAIResponse(text) {
                let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html = html.replace(/\n/g, '<br>');
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/^\s*[-*]\s/gm, '<br>‚Ä¢ ');
                return html;
            }
        });
    </script>
</body>
</html>
